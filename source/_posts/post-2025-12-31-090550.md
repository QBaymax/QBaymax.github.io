---

title: 半自动探针台 SemiShare-X8 通讯问题初解

date: 2025-12-31 09:05:50

categories: 网络 # 将文章归入“日记”分类

tags: [fab,网络]

diary: false

---

## GPIB 问题

GPIB 首先是需要相应的驱动才可以使用的，目前主流的两个厂家为 NI 和 Keysight，因此驱动也分为两种，我们常用的都是 NI 家的，因此需要去 NI 的官网下载最新版的 488.2 应用，在此可以可以选择不下载 LabViewer 之类不需要的插件，这样会下载的快一点。

> **注意**：如果在下载过程中出现部分文件下载 error 等缺失问题，一定要重新下载，以防后续出现莫名其妙的问题。

下载好 NI 后，需要重启电脑，重启后我们再配置 NI Visa 的部分，以更好的识别我们的设备。首先打开 NI Max 应用，在应用左上角应该可以看到如下你的 GPIB 线信息：

![image-20251226151501823](C:\Users\12869\AppData\Roaming\Typora\typora-user-images\image-20251226151501823.png)

但是可能出现扫描不到设备的情况，此时点击工具->NI Visa ->VISA Options：

![image-20251226151005199](C:\Users\12869\AppData\Roaming\Typora\typora-user-images\image-20251226151005199.png)

勾选 Show all devices accessible to VISA：

![image-20251226151137011](C:\Users\12869\AppData\Roaming\Typora\typora-user-images\image-20251226151137011.png)

勾选下面这堆东西：

![image-20251226151336980](C:\Users\12869\AppData\Roaming\Typora\typora-user-images\image-20251226151336980.png)

然后重新扫描设备，一般情况下就可以出现链接的设备了：

![image-20251226151620060](C:\Users\12869\AppData\Roaming\Typora\typora-user-images\image-20251226151620060.png)

此时你就可以通过与仪器通信，使用命令 *IDN? 查询 visa 通信是否存在问题。



## 半自动探针台 SemiShare-X8 连接

#### GPIB 连接

但此时发现半自动探针台依然无法通过 GPIB 连接，可以确认的是，电脑无异常，GPIB 线无异常，设备的 GPIB 接口应该也无异常，那么异常大概率是出现在设备中，存在某个东西阻碍了电脑与设备之间的通信，因此我们可以抱有如下怀疑：

1、GPIB 端口绑定失败；

2、设备防火墙阻挡了信号传输；

3、设备软件本身存在问题；

#### TCP/IP 连接

除了 GPIB 连接方式，还有 TCP/IP 连接方式。

##### WNA 与 LNA 网口

此时也存在问题：设备的网口为广域网 WNA 网口，与我们常见的局域网 LAN 网口有不同之处。WNA 网口的主要目的是连接互联网，当接口连接网线后，他会尝试从网络中的 DHCP 服务器获取 IP 地址，如果在一段时间内没有获取到有效的 IP 地址（如 DHCP 服务器故障、网络层级问题），设备就会自动给自己分配一个 APIPA 地址。

APIPA 地址的作用主要是让设备在没有获取到正常 IP 地址的情况下，仍然能够在本地网络中进行有限的通信，但不能访问外部网络（如互联网）。而 APIPA 地址范围为（169.254.0.1 - 169.254.255.254)，以此判断设备是否连接到互联网。

在本情况下，在接入 WNA 网口后，设备分配的静态 IP 为 169.254.21.195，显然是没有接入互联网，这也是可以理解的。因为 WNA 的另一端是电脑的 LNA 接口，因为电脑自身没有启动 DHCP 服务，因此无法为设备分配互联网地址。但我们的需求是构建局域网，因此上述问题无关紧要。

##### 局域网通信

为了实现设备与电脑的通信，我们需要将设备与电脑的 IP 以及子网掩码改到同一字段内，如下：

- [ ] 设备 IP：10.0.60.31
- [ ] 设备子网掩码：255.255.0.0
- [ ] 设备网关：10.0.60.1
- [ ] 电脑 IP：10.0.60.2
- [ ] 电脑子网掩码：255.255.0.0
- [ ] 电脑网关：10.0.60.1

此时在正常情况下，设备就可以与电脑产生连接了，也即通过电脑可以 ping 到设备的 IP 地址，类似于直接通过 LNA 接口互联一样。但实际情况是依然无法互联，如 GPIB 连接一般，因此我们抱有如下怀疑：

1、设备的防火墙阻止了电脑 ping 的请求；

2、网线连接出现问题；

3、网卡出了问题；

根据我的经验判断，2和3应该不会出现问题，所以首先调试问题1，我们做如下操作：

1. 打开“控制面板” > “系统和安全” > “Windows Defender 防火墙”。
2. 点击“高级设置”，在“Windows Defender 防火墙与高级安全”中，选择“入站规则”。
3. 在右侧找到“文件和打印机共享（Echo Request - ICMPv4-In）”，启用该规则。
4. 如果需要，也可以在“出站规则”中启用对应的ICMP规则。

##### ICMP 互联网控制消息协议（网络层）

ICMP 具有错误报告、查询和响应两个主要功能，定义了多种类型的消息：

- 类型0：回显应答；
- 类型3：目的不可达；
- 类型5：重定向；
- 类型8：回显请求；
- 类型11：超时；

每种类型消息还可以有多个代码值，用于进一步描述错误或事件。如类型3的消息有以下代码：

- 代码0：网络不可达；
- 代码1：主机不可达；
- 代码3：端口不可达；

基于此 ICMP 的主要应用就是作为一种网络诊断工具，如 Ping；防火墙可以利用 ICMP 消息来控制网络流量，例如阻止 ICMP 回显请求可以防止外部主机通过 Ping 探测内部网络。

##### 端口绑定及其防火墙

在准许了 ICMP 的入站/出站协议后，确实可以通过电脑 Ping 到设备 10.0.60.31 的 IP 地址了，但是在使用 visa 连接设备的端口地址：TCPIP::10.0.60.31::9999::SOCKET 时依然出现了 Time out 的问题，此时怀疑的角度就指向了：

1、服务器监听地址绑定；

2、防火墙阻止外部 IP 对 9999 端口的访问；

我们首先检查端口 9999 确实无法连接，利用的命令为 telent 测试端口的连接性，但一般电脑上默认是没有打开这个功能的，我们首先打开功能：

1. 按 `Win + R`，输入 `appwiz.cpl`，回车
2. 点击左侧"**启用或关闭Windows功能**"
3. 在弹出的窗口中，找到"**Telnet客户端**"
4. **勾选**它
5. 点击"确定"，等待安装完成
6. **重启命令提示符或PowerShell**

此时输入命令：

```cmd
telnet 10.0.60.31 9999
```

情况1：telnet连接成功后清屏是**标准行为**，表示：

- 与设备建立了TCP连接
- 进入交互模式，等待输入命令
- 此时可手动输入SCPI指令（如`*IDN?`）测试设备响应

​	**退出telnet方法**：按 `Ctrl+]` 进入命令模式，输入 `quit` 回车。

情况2：端口被拒绝

```
正在连接到10.0.60.31...
无法打开到主机的连接，在端口 9999：连接失败
```

情况3：端口开放但无响应（连接即断开）

```
正在连接到10.0.60.31...
连接成功！
# 立即断开，返回命令行
# 这可能表示端口需要特定协议握手
```

情况4：连接超时

```
正在连接到10.0.60.31...
# 光标闪烁几秒后
无法打开到主机的连接，在端口 9999：连接超时
```

我们其次检查服务器监听地址9999端口绑定的 IP 有哪些，利用如下命令：

```cmd
netstat -ano | findstr "9999"
```

显示结果为：

```cmd
0.0.0.0:9999   0.0.0.0:0     LISTENING  848
127.0.0.1:9999   127.0.0.1:50915    ESTABLISEHED   848
1270.0.1:50915  127.0.0.1:9999  ESTABLISHED  9584
```

可以看到监听是正常的，其中 PID848 进程正在监听所有网络 0.0.0.0，理论上来说是可以通过电脑访问设备的9999端口的。后两行表示设备上自带的软件 QuickLink（PID 9584）正在通过本地回环地址与 9999 端口通信，属于正常内部通信。所以问题1不是导致 Time out 的因素。

针对防火墙问题，可能有如下几个因素：

1. Windows防火墙阻止外部连接

2. Windows防火墙配置文件问题

3. 第三方安全软件拦截

针对问题1：

在设备上（通过远程桌面或直接在设备操作）执行以下命令，开放9999端口：

```cmd
# 以管理员身份运行命令提示符
netsh advfirewall firewall add rule name="VISA Instrument 9999" dir=in action=allow protocol=TCP localport=9999
```

验证规则是否生效：

```cmd
netsh advfirewall firewall show rule name="VISA Instrument 9999"
```

针对问题2：

如果设备连接的以太网络被识别为"公用网络"，防火墙规则会更严格。

检查当前网络配置文件：

```powershell
# 在设备上运行PowerShell
Get-NetConnectionProfile
```

**如果是"Public"（公用），改为"Private"（专用）**：

```powershell
Set-NetConnectionProfile -InterfaceAlias "以太网" -NetworkCategory Private
```

*（将"以太网"替换为实际的网络适配器名称）*

通过上述的配置，可以在设备电脑检测到可以连接到 TCPIP::10.0.60.31::9999::SOCKET 地址，但是在施加通讯 *IDN? 时依然失败，使用 telnet 进行连接，可以正常输入 *IDN？命令查询设备信息，所以怀疑的目标为命令本身的格式。SOCKET连接必须手动设置终止符，telnet 是原始 TCP 连接，而 VISA 的 SOCKET 模式需要显式配置终止字符，否则设备不识别命令结束，导致超时或报错，因此我们在 python 代码中插入如下内容：

```python
inst = rm.open_resource(RESOURCE_STRING)

# 关键步骤：设置终止字符（必须！）
inst.read_termination = '\n'   # 读取时以换行符结束
inst.write_termination = '\n'  # 写入时自动添加换行符
```

此时再次运行，发现可以正常通信了，解决问题！！！
